<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-router从源码到实践到进阶 | 技匠</title>
    <meta name="description" content="前端知识深入学习">
    
    
    <link rel="preload" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css" as="style"><link rel="preload" href="/xuege-learning/dist/assets/js/app.2fd7c63d.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/2.304eb466.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/5.19d8483c.js" as="script"><link rel="prefetch" href="/xuege-learning/dist/assets/js/10.ce208702.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/11.dccc70ad.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/12.a01dc21f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/13.be88cd92.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/14.62ffab80.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/15.4f224b22.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/16.431e0be0.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/17.285c1804.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/18.50ec12ca.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/19.84104556.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/20.cac591c5.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/21.eff5804e.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/22.8e9b71e8.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/23.f483a31f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/24.cfddc827.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/25.12bf2e52.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/26.3c41a385.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/27.45ef8e6f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/28.c37eb3bf.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/29.34f4280f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/3.16d19a3b.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/30.0458713b.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/31.3fbfeaa2.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/32.b50d55e5.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/33.d31d3f91.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/34.b0ffa556.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/35.b080b67a.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/36.e45d5e9c.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/37.095bd4d5.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/4.3f2d9650.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/6.4148b401.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/7.117a24c3.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/8.9f62239a.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/9.83ea6150.js">
    <link rel="stylesheet" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xuege-learning/dist/" class="home-link router-link-active"><!----> <span class="site-name">技匠</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>vue-router从源码到实践到进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#目录" class="sidebar-link">目录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#pushstate-replacestate-popstate-解析" class="sidebar-link">pushState/replaceState/popstate 解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#pushstate-replacestate-方法" class="sidebar-link">pushState/replaceState() 方法</a></li><li class="sidebar-sub-header"><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#popstate" class="sidebar-link">popstate</a></li></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#vue-router-实现原理" class="sidebar-link">vue-router 实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#安装-vue-router" class="sidebar-link">安装 vue-router</a></li><li class="sidebar-sub-header"><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#router-view-实现视图更新" class="sidebar-link">router-view 实现视图更新</a></li><li class="sidebar-sub-header"><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#创建-route-对象" class="sidebar-link">创建 route 对象</a></li></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#route-跟-router-的区别" class="sidebar-link">route 跟 router 的区别</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#通过路由元信息，设置登录" class="sidebar-link">通过路由元信息，设置登录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#设置滚动行为" class="sidebar-link">设置滚动行为</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#vue-路由-按需-keep-alive" class="sidebar-link">vue 路由 按需 keep-alive</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#watch-监听路由变化" class="sidebar-link">watch 监听路由变化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#如何检测物理键返回" class="sidebar-link">如何检测物理键返回</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#如何做出翻书效果" class="sidebar-link">如何做出翻书效果</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/vue/vue-router/vue-router%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AE%9E%E8%B7%B5%E5%88%B0%E8%BF%9B%E9%98%B6.html#如何做一个优雅的路由分区" class="sidebar-link">如何做一个优雅的路由分区</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-router从源码到实践到进阶"><a href="#vue-router从源码到实践到进阶" aria-hidden="true" class="header-anchor">#</a> vue-router从源码到实践到进阶</h1> <p>✅代表已经完成</p> <p>❎留到下期</p> <h2 id="目录"><a href="#目录" aria-hidden="true" class="header-anchor">#</a> 目录</h2> <ul><li>✅pushState/replaceState/popstate 解析</li> <li>✅vue-router 实现原理</li> <li>✅route 跟 router 的区别</li> <li>✅通过路由元信息，设置登录</li> <li>✅设置滚动行为</li> <li>✅vue 路由 按需 keep-alive</li> <li>✅watch 监听路由变化</li> <li>✅如何检测物理键返回</li> <li>✅如何做出翻书效果</li> <li>✅如何做一个优雅的路由分区</li> <li>❎根据目录实现自动生成路由</li> <li>❎根据路由规则生成页面</li></ul> <blockquote><p>先了解了浏览器的<code>history</code>原理，才能更好的结合<code>vue-router</code>源码一步步了解它的实现。如果这块已经有了解可以直接跳过。</p></blockquote> <h2 id="pushstate-replacestate-popstate-解析"><a href="#pushstate-replacestate-popstate-解析" aria-hidden="true" class="header-anchor">#</a> pushState/replaceState/popstate 解析</h2> <p><code>HTML5</code>开始提供了对<code>history</code>栈中内容的操作。通过<code>history.pushState/replaceState</code>实现添加地址到<code>history</code>栈中。</p> <h3 id="pushstate-replacestate-方法"><a href="#pushstate-replacestate-方法" aria-hidden="true" class="header-anchor">#</a> pushState/replaceState() 方法</h3> <blockquote><p>pushState() 需要三个参数: 一个状态对象, 一个标题 (目前被忽略), 和 (可选的) 一个URL. 让我们来解释下这三个参数详细内容：</p></blockquote> <ul><li><p><code>状态对象</code> — 状态对象state是一个JavaScript对象，通过pushState () 创建新的历史记录条目。无论什么时候用户导航到新的状态，popstate事件就会被触发，且该事件的state属性包含该历史记录条目状态对象的副本。</p> <p>状态对象可以是能被序列化的任何东西。原因在于Firefox将状态对象保存在用户的磁盘上，以便在用户重启浏览器时使用，我们规定了状态对象在序列化表示后有640k的大小限制。如果你给 pushState() 方法传了一个序列化后大于640k的状态对象，该方法会抛出异常。如果你需要更大的空间，建议使用 sessionStorage 以及 localStorage.</p></li> <li><p><code>标题</code> — Firefox 目前忽略这个参数，但未来可能会用到。在此处传一个空字符串应该可以安全的防范未来这个方法的更改。或者，你可以为跳转的state传递一个短标题。</p></li> <li><p><code>URL</code> — 该参数定义了新的历史URL记录。注意，调用 pushState() 后浏览器并不会立即加载这个URL，但可能会在稍后某些情况下加载这个URL，比如在用户重新打开浏览器时。新URL不必须为绝对路径。如果新URL是相对路径，那么它将被作为相对于当前URL处理。新URL必须与当前URL同源，否则 pushState() 会抛出一个异常。该参数是可选的，缺省为当前URL。</p></li></ul> <p>改变历史记录条目</p> <div class="language-js extra-class"><pre class="language-js"><code>@clickA
history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> page<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@clickB
history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> page<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/xuege-learning/dist/assets/img/pushstate.67d9adcf.gif" alt="pushstate"></p> <h3 id="popstate"><a href="#popstate" aria-hidden="true" class="header-anchor">#</a> popstate</h3> <p>当历史记录条目更改时，将触发<code>popstate</code>事件。如果被激活的历史记录条目是通过对<code>history.pushState（）</code>的调用创建的，或者受到对<code>history.replaceState（）</code>的调用的影响，<code>popstate</code>事件的<code>state</code>属性包含历史条目的状态对象的副本。</p> <p>需要注意的是调用<code>history.pushState()</code>或<code>history.replaceState()</code>不会触发<code>popstate</code>事件。只有在做出<code>浏览器动作</code>时，才会触发该事件，如用户点击浏览器的回退按钮（或者在<code>Javascript</code>代码中调用<code>history.back()</code>）</p> <p>触发浏览器回退按钮</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/xuege-learning/dist/assets/img/popstate.06314a1c.gif" alt="popstate"></p> <h2 id="vue-router-实现原理"><a href="#vue-router-实现原理" aria-hidden="true" class="header-anchor">#</a> vue-router 实现原理</h2> <blockquote><p>总体来说就是使用了<code>history</code>的方法来控制浏览器的路由，结合<code>vue</code>实现数据与视图更新。上面我们已经讲了<code>history</code>的使用原理，接下来结合<code>vue-router</code>具体来看一下</p></blockquote> <h3 id="安装-vue-router"><a href="#安装-vue-router" aria-hidden="true" class="header-anchor">#</a> 安装 vue-router</h3> <p><code>install.js</code></p> <ul><li>通过 <code>Object.defineProperty</code> 将 <code>_router</code> 挂载在 <code>Vue</code> 原型的 <code>$router</code> 属性的 <code>get</code> 函数上。这样可以通过 <code>this.$router</code> 来调用 <code>_router</code>。使用<code>get</code>的好处是，保证了安全性，只能读不能修改 <code>$router</code>。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 项目内可以通过 this.$router 来获取到</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$router'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_router <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后，在 <code>Vue.mixin</code> 中注入 <code>beforeCreate</code> 钩子函数，每个组件都会调用 <code>registerInstance</code> ， 通过 <code>Vue.util.defineReactive</code> 将 <code>_route</code> 进行监听，这样每次进入到新的页面就会设置当前的路由。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在 `beforeCreate` 中调用了 `registerInstance` </span>
<span class="token comment">// 其实就是调用了 router-view 组件中的 registerRouteInstance 方法</span>
<span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> callVal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
      <span class="token comment">// 初始化设置监听 popstate</span>
      <span class="token comment">// 并将 this._route = route</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// 亮点在这！！！</span>
      <span class="token comment">// 将 _route 添加监听，当修改 history.current 时就可以触发更新了</span>
      Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 注册实例，调用 router-view 中的方法，修改 route 值，从而更新视图</span>
    <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 销毁注册实例，因为注册的实例是 undefined</span>
    <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="router-view-实现视图更新"><a href="#router-view-实现视图更新" aria-hidden="true" class="header-anchor">#</a> <code>router-view</code> 实现视图更新</h3> <p><code>router-view</code> 是一个函数式组件，页面中 <code>beforeCreate</code> 钩子调用<code>registerRouteInstance</code> 来修改当前 <code>route</code> 实例，由于 <code>_route</code> 已经被监听了，所以当 <code>matched.instances[name]</code> 发生变化的时候，会重新触发 <code>render</code> 更新视图。</p> <p><code>omponents/view.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>data<span class="token punctuation">.</span><span class="token function-variable function">registerRouteInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token comment">// 注册路由实例，如果与当前路由与原来路由相等则不变，如果不相等则更新实例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">!==</span> vm<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> vm<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 修改当前路由实例</span>
    matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建-route-对象"><a href="#创建-route-对象" aria-hidden="true" class="header-anchor">#</a> 创建 route 对象</h3> <p>创建路由 <code>createRoute</code>，通过解析<code>location</code>等操作，返回一个<code>route</code>对象</p> <p><code>src/util/route.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoute</span> <span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Location<span class="token punctuation">,</span>
  router<span class="token operator">?</span><span class="token punctuation">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringifyQuery <span class="token operator">=</span> router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>stringifyQuery

  <span class="token keyword">let</span> query<span class="token punctuation">:</span> any <span class="token operator">=</span> location<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    query <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">const</span> route<span class="token punctuation">:</span> Route <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> location<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> location<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    hash<span class="token punctuation">:</span> location<span class="token punctuation">.</span>hash <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> location<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    fullPath<span class="token punctuation">:</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span><span class="token punctuation">,</span>
    matched<span class="token punctuation">:</span> record <span class="token operator">?</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>这里主要讲了，<code>vue-router</code> 的 <code>install</code>，<code>router-view</code> 实现视图渲染，<code>create-route</code> 创建路由实例，还有如何实现与vue的结合，实现数据绑定等。由于篇幅的问题，再多细节的东西就没有讲了，有兴趣大家可以翻翻源码。</p></blockquote> <p><img src="/xuege-learning/dist/assets/img/liuchengtu.2f97790f.png" alt="liuchengtu"></p> <h2 id="route-跟-router-的区别"><a href="#route-跟-router-的区别" aria-hidden="true" class="header-anchor">#</a> route 跟 router 的区别</h2> <p>讲完原理给大家捋一下 route 跟 router 的区别，通过源码很容易看出他们的不同</p> <ul><li><p><code>$router</code> 是router是VueRouter的一个对象，通过Vue.use(VueRouter)和VueRouter构造函数得到一个router的实例对象，这个对象中是一个全局的对象，他包含了所有的路由包含了许多关键的对象和属性。</p></li> <li><p>$route 就是一个路由的对象，我们通过 createRoute 创建出来的 route 对象，里面包括</p></li></ul> <p><code>$route.path</code></p> <p>字符串，等于当前路由对象的路径，会被解析为绝对路径，如 &quot;/home/news&quot; 。</p> <p><code>$route.params</code></p> <p>对象，包含路由中的动态片段和全匹配片段的键值对</p> <p><code>$route.query</code></p> <p>对象，包含路由中查询参数的键值对。例如，对于 /home/news/detail/01?favorite=yes ，会得到$route.query.favorite == 'yes' 。</p> <p><code>$route.router</code></p> <p>路由规则所属的路由器（以及其所属的组件）。</p> <p><code>$route.matched</code></p> <p>数组，包含当前匹配的路径中所包含的所有片段所对应的配置参数对象。</p> <p><code>$route.name</code></p> <p>当前路径的名字，如果没有使用具名路径，则名字为空。</p> <h2 id="通过路由元信息，设置登录"><a href="#通过路由元信息，设置登录" aria-hidden="true" class="header-anchor">#</a> 通过路由元信息，设置登录</h2> <p>原理是在路由的 <code>meta</code> 里设置 <code>auth</code> 属性，进入路由之前判断 <code>meta.auth</code> 是否为 <code>true</code> ，如果为 <code>true</code> 再判断，是否已经登陆，没有登陆的话调 <code>login</code> 方法去登陆，登陆成功后 回调 <code>code === 0</code> 继续进入页面</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">beforeEnter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 未登陆走登陆逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">nextPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> targetUrl <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'#'</span> <span class="token operator">+</span> to<span class="token punctuation">.</span>fullPath
      <span class="token comment">// 这里是你的登陆逻辑</span>
      <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 回调后进入页面</span>
        callback<span class="token punctuation">:</span> nextPage<span class="token punctuation">,</span> 
        <span class="token comment">// 目标页面，登陆成功后进入目标页面</span>
        targetUrl<span class="token punctuation">:</span> targetUrl 
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Foo 组件设置登陆</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">'/Foo'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'Foo'</span><span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      auth<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">'Foo.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">'/Bar'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'Bar'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">'Bar.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="设置滚动行为"><a href="#设置滚动行为" aria-hidden="true" class="header-anchor">#</a> 设置滚动行为</h2> <p>设置滚动行为，并添加路由，如果有 <code>savedPosition</code> 说明是第二次进入并已经触发过滚动，所以会滚动到之前打开的位置，如果是第一次进入没有<code>savedPosition</code>则滚动到最顶层。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">scrollBehavior</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> savedPosition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>savedPosition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> savedPosition
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  routes
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="vue-路由-按需-keep-alive"><a href="#vue-路由-按需-keep-alive" aria-hidden="true" class="header-anchor">#</a> vue 路由 按需 keep-alive</h2> <p><code>&lt;keep-alive&gt;</code> 包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。和 <code>&lt;transition&gt;</code> 相似，<code>&lt;keep-alive&gt;</code> 是一个抽象组件：它自身不会渲染一个 <code>DOM</code> 元素，也不会出现在父组件链中。</p> <p>当组件在 <code>&lt;keep-alive&gt;</code> 内被切换，它的 <code>activated</code> 和 <code>deactivated</code> 这两个生命周期钩子函数将会被对应执行。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 需要缓存的视图组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>$route.meta.keepAlive<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 不需要缓存的视图组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>!$route.meta.keepAlive<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>路由配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> routers <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./views/keep-alive/list.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      keepAlive<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>因为在我们项目里面经常会有列表跳详情，然后又详情返回列表的情况，所以我们可以根据项目需求来判断是否需要被缓存，如果被缓存了就会出现下面的情况需要注意</p> <h2 id="watch-监听路由变化"><a href="#watch-监听路由变化" aria-hidden="true" class="header-anchor">#</a> watch 监听路由变化</h2> <p>有时我们需要通过给页面传参来判断页面展示什么内容，比如详情页 <code>#/detail?infoId=123456</code>，我们需要根据 <code>infoId</code> 来展示不同的内容</p> <p>我们一般习惯会这样写</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pullData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token function">pullData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://test.m.com/detail'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> infoId <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我们通过列表再次进入详情页时，虽然<code>infoId</code>已经变了<code>infoId=234567</code>，但是页面并没有改变，是因为该页面被<code>keep-alive</code>了，<code>created</code>不会再次触发，<code>created</code>只在创建的时候执行一次。</p> <p>为了解决这个问题，我们就需要对 <code>$route</code> 进行监听，只要 <code>route</code> 发生变化我们就更新页面</p> <div class="language-js extra-class"><pre class="language-js"><code>watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token string">'$route'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 页面初始化时立即触发一次</span>
    immediate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只有进入当前页面的时候，拉取数据</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/detail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pullData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样还会带来下面的问题，就是物理键返回的时候也会刷新页面，下面是对物理键返回的处理</p> <h2 id="如何检测物理键返回"><a href="#如何检测物理键返回" aria-hidden="true" class="header-anchor">#</a> 如何检测物理键返回</h2> <p>为什么要检测物理返回键？比如你有这样列表页，点击进去是一个是一个详情页，然后返回的时候列表刷新了，找不到原来的位置，这种时候对用户的体验非常不好。我们看一下例子。</p> <p><img src="/xuege-learning/dist/assets/img/onback2.72ca1ac5.gif" alt="onback2"></p> <p><code>那么我们如何去优化它？</code>思路就是在用户返回到列表页的时候不刷新数据，只有在用户主动进入列表的时候才会刷新数据，我们看一下效果</p> <p><img src="/xuege-learning/dist/assets/img/onback3.00b9b089.gif" alt="onback3"></p> <p>下面是实现的代码，原理就是监听 <code>popstate</code>，当浏览器返回的时候会触发 <code>popstate</code>，这时我们标记 <code>isBack</code> 为 <code>ture</code>。在 <code>setTimeout 0</code> 之后判断 <code>isBack</code>（是否为浏览器返回），如果不是浏览器返回的再刷新数据。</p> <div class="language-js extra-class"><pre class="language-js"><code>@Component
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 用来判断是否是通过返回键返回的</span>
      isBack<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">created</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是物理键返回的就设置 isBack = true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$_onBack</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isBack <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'$route'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      immediate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 每次进入路由重置 isBack = false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isBack <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 等待路由的 popstate 监听结束</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBack <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pullData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>_onBack 实现</code>，就是监听了 <code>popstate</code> ，因为<code>vue-router</code>是操作了<code>history</code>的状态，而浏览器返回的时候就会触发 popstate ，利用这个特性来判断是否为浏览器返回键返回</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_onBack</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">&quot;popstate&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> cb  <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="如何做出翻书效果"><a href="#如何做出翻书效果" aria-hidden="true" class="header-anchor">#</a> 如何做出翻书效果</h2> <p>利用的是 <code>vue</code> 的 <code>transition</code> 组件，结合 <code>vue-router</code>，在路由上做一些过渡效果。先看图说话</p> <p><img src="/xuege-learning/dist/assets/img/fanshu.d7752263.gif" alt="fanshu"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transition</span> <span class="token attr-name">:name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>transitionName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>child-view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transition</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      transitionName<span class="token punctuation">:</span> <span class="token string">'turning-down'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>  
    <span class="token string">'$route'</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
      <span class="token keyword">if</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">&gt;</span> <span class="token keyword">from</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 进入下一页</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transitionName <span class="token operator">=</span> <span class="token string">'turning-up'</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>  
        <span class="token comment">// 返回上一页</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transitionName <span class="token operator">=</span> <span class="token string">'turning-down'</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.child-view</span> <span class="token punctuation">{</span>  
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>  
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>  
  <span class="token property">transition</span><span class="token punctuation">:</span> all 4s ease<span class="token punctuation">;</span>
  <span class="token property">transform-origin</span><span class="token punctuation">:</span> 0% center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.turning-down-enter</span><span class="token punctuation">{</span>
  <span class="token property">opacity</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token property">transform-origin</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
  <span class="token property">transform-style</span><span class="token punctuation">:</span> preserve-3d<span class="token punctuation">;</span>
  <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">perspective</span><span class="token punctuation">(</span>1000px<span class="token punctuation">)</span> <span class="token function">rotateY</span><span class="token punctuation">(</span>-180deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">perspective</span><span class="token punctuation">(</span>1000px<span class="token punctuation">)</span> <span class="token function">rotateY</span><span class="token punctuation">(</span>-180deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.turning-up-leave-active</span> <span class="token punctuation">{</span>
  <span class="token property">transform-style</span><span class="token punctuation">:</span> preserve-3d<span class="token punctuation">;</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">perspective</span><span class="token punctuation">(</span>1000px<span class="token punctuation">)</span> <span class="token function">rotateY</span><span class="token punctuation">(</span>-180deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> 100<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>配置路由</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">'/Home'</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../views/vue/vue-router/Home.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'/Home/First'</span><span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> <span class="token string">'Home-First'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../views/vue/vue-router/First.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'/Home/Second'</span><span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> <span class="token string">'Home-Second'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../views/vue/vue-router/Second.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>通过监听 <code>Home</code> 页面的路由变化，来改变 <code>transitionName</code>，路由切换时切换 <code>transition</code> 组件的 <code>enter/leave-active</code> 样式，因此可以在路由切换时做到翻书效果。</p> <h2 id="如何做一个优雅的路由分区"><a href="#如何做一个优雅的路由分区" aria-hidden="true" class="header-anchor">#</a> 如何做一个优雅的路由分区</h2> <p>随着项目的增大，项目中的页面可能达到好几十个，甚至更多，那么如何将这些页面进行管理呢？我们的做法就是，将路由按照功能进行区分。</p> <p>比如我们分了5个区间，每个区间有个数不同的路由</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">--</span> a<span class="token punctuation">.</span>js
<span class="token operator">--</span> b<span class="token punctuation">.</span>js
<span class="token operator">--</span> c<span class="token punctuation">.</span>js
<span class="token operator">--</span> d<span class="token punctuation">.</span>js
<span class="token operator">--</span> e<span class="token punctuation">.</span>js
</code></pre></div><p>我们需要将这五个路由分别引进来，并进行结合</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'routers/a'</span>
<span class="token keyword">import</span> b <span class="token keyword">from</span> <span class="token string">'routers/b'</span>
<span class="token keyword">import</span> c <span class="token keyword">from</span> <span class="token string">'routers/c'</span>
<span class="token keyword">import</span> d <span class="token keyword">from</span> <span class="token string">'routers/d'</span>
<span class="token keyword">import</span> e <span class="token keyword">from</span> <span class="token string">'routers/e'</span>

<span class="token keyword">const</span> routers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
</code></pre></div><p>以后我们每次建一个新的分区，都要手动加上相应的逻辑，这样看起来很不方便，那么我们有没有好的解决办法呢？</p> <p>下面是我做的路由分区，利用 <code>webpack</code> 的 <code>require.context</code> 方法，将所有需要的路径导出来，<code>require.context</code> 有三个参数</p> <ul><li><code>第一个参数</code>，匹配的路径目录，（从当前目录开始算起）</li> <li><code>第二个参数</code>，是否需要深层遍历</li> <li><code>第三个参数</code>，正则匹配，匹配出你需要的路径</li></ul> <p><strong>需要注意的点，<code>require</code> 不能直接导出变量名</strong></p> <p>例如，下面的例子会报错</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">'./route/a.js'</span>
<span class="token comment">// 会报错，a 不是一个模块</span>
<span class="token function">require</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre></div><p>所以 <code>require</code> 中只能加字符串或者使用字符串拼接</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">'a.js'</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./route/'</span> <span class="token operator">+</span> a<span class="token punctuation">)</span>
</code></pre></div><p>这样webpack会把 <code>./route/</code> 下所有文件打包成模块，你才可以使用 <code>require</code> 去引用</p> <p>下面是一个完成的例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'vue-router'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Router<span class="token punctuation">)</span>

<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\/[\w]+\.(js|ts)$/</span><span class="token punctuation">)</span>

context<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  routes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/'</span> <span class="token operator">+</span>  path<span class="token punctuation">)</span><span class="token punctuation">.</span>routes<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> redirect<span class="token punctuation">:</span> <span class="token string">'/Home'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>routes
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>参考文章</p> <p>https://juejin.im/post/5cdcbae9e51d454759351d84</p> <p>https://segmentfault.com/a/1190000018173547?utm_source=tag-newest</p> <p>https://www.cnblogs.com/czy960731/p/9288830.html</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/xuege-learning/dist/assets/js/app.2fd7c63d.js" defer></script><script src="/xuege-learning/dist/assets/js/2.304eb466.js" defer></script><script src="/xuege-learning/dist/assets/js/5.19d8483c.js" defer></script>
  </body>
</html>
