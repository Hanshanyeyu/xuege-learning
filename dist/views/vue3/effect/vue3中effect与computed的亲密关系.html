<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue3中effect与computed的亲密关系 | 技匠</title>
    <meta name="description" content="前端知识深入学习">
    
    
    <link rel="preload" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css" as="style"><link rel="preload" href="/xuege-learning/dist/assets/js/app.1272842f.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/2.9a27edc2.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/17.7b065a7a.js" as="script"><link rel="prefetch" href="/xuege-learning/dist/assets/js/10.1edc887d.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/11.c33cd1d6.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/12.95634cf7.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/13.8273144d.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/14.76e522c6.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/15.6e6c3322.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/16.754eee8b.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/18.9918dab7.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/19.70815744.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/3.7c8edd8c.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/4.9c46e92c.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/5.92d6629d.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/6.88e5c412.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/7.6ceebf39.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/8.cdc2287e.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/9.2f8cf3ca.js">
    <link rel="stylesheet" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xuege-learning/dist/" class="home-link router-link-active"><!----> <span class="site-name">技匠</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>vue3中effect与computed的亲密关系</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue3中effect与computed的亲密关系"><a href="#vue3中effect与computed的亲密关系" aria-hidden="true" class="header-anchor">#</a> vue3中effect与computed的亲密关系</h1> <blockquote><p>在我刚看完vue3响应式的时候，心中就有一个不可磨灭的谜团，让我茶不思饭不想，总想生病。那么这个谜团是什么呢？就是在响应式中一直穿行在tranger跟track之间的effect。如果单纯的响应式原理根本就用不上effect，那么effect到底是干什么的呢？</p></blockquote> <h4 id="船到桥头自然直，柳岸花明又一村。苦心人天不负，偶然间我看到了effect测试代码用例！"><a href="#船到桥头自然直，柳岸花明又一村。苦心人天不负，偶然间我看到了effect测试代码用例！" aria-hidden="true" class="header-anchor">#</a> 船到桥头自然直，柳岸花明又一村。苦心人天不负，偶然间我看到了effect测试代码用例！</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe basic properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dummy
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>解释一下，这段代码</p> <ul><li>首先声明dummy变量，然后在effect的回调中把已响应的对象counter的num属性赋值给dummy</li> <li>然后做断言判断 dummy是否等于 0</li> <li>将 counter.num 赋值 7 ，然后 dummy 也变成了 7 ！</li></ul> <p>这，，，让我想到了什么？？</p> <h5 id="这就是computed的吗？"><a href="#这就是computed的吗？" aria-hidden="true" class="header-anchor">#</a> 这就是computed的吗？</h5> <p>赶紧看下 computed 的测试用例！！</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> value <span class="token operator">=</span> reactive<span class="token operator">&lt;</span><span class="token punctuation">{</span> foo<span class="token operator">?</span><span class="token punctuation">:</span> number <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">expect</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>哈哈哈</p> <p>阿哈哈哈哈</p> <p>hhhhhhhhhhhhhhhhhhhh</p> <p>忍不住想仰天长啸！！</p> <blockquote><p>果然跟我猜想的一样！！！我终于直到effect是个什么鬼了，顾名思义effect是副作用的意思，也就是说它是响应式副产品，每次触发了 get 时收集effect，每次set时在触发这些effects。这样就可以做一些响应式数据之外的一些事情了，比如计算属性computed。</p></blockquote> <h4 id="让我们用effect实现一个computed-可能会更清晰一点"><a href="#让我们用effect实现一个computed-可能会更清晰一点" aria-hidden="true" class="header-anchor">#</a> 让我们用effect实现一个computed 可能会更清晰一点</h4> <p>我就不写一些乱七八糟的判断了，让大家能够看的更加清楚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">computed</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">undefined</span>
  <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果lazy不置为true的话，每次创建effect的时候都会立即执行一次</span>
    <span class="token comment">// 而我们要实现computed显然是不需要的</span>
    lazy<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 为什么要使用对象的形式，是因为我们最后需要得到computed的值</span>
  <span class="token comment">// 如果不用对象的 get 方法的话我们就需要手动再调用一次 computed() </span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用起来是这样的</span>

<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre></div><h4 id="这也太简单了吧，那么重点来了，effect怎么实现的呢？"><a href="#这也太简单了吧，那么重点来了，effect怎么实现的呢？" aria-hidden="true" class="header-anchor">#</a> 这也太简单了吧，那么重点来了，effect怎么实现的呢？</h4> <p>别着急，我们先捋一下逻辑</p> <ol><li>首先 如果 effect 回调内有已响应的对象被触发了 get 时，effect就应该被储存起来</li> <li>然后，我们需要一个储存effect的地方，在effect函数调用的时候就应该把effect放进这个储存空间，在vue中使用的是一个数组activeReactiveEffectStack = []</li> <li>再后，每个target被触发的时候，都可能有多个effect，所以每个target需要有一个对应的依赖收集器 deps，等到 set 时遍历 deps 执行 effect()</li> <li>然而，这个依赖收集器 deps 不能放在 target 本身上，这样会使数据看起来不是很简洁，还会存在多余无用的数据，所以我们需要一个 map 集合来储存 target 跟 deps 的关系， 在vue中这个储存集合叫 targetMap 。</li></ol> <h5 id="几个概念"><a href="#几个概念" aria-hidden="true" class="header-anchor">#</a> 几个概念</h5> <ol><li>track 追踪器，在 get 时调用该函数，将所有 get 的 target 跟 key 以及 effect 建立起对应关系</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 比如 const react = reactive({a: { b: 2 })</span>
<span class="token comment">// react.a 时 target -&gt; {a: { b: 2 } key -&gt; a </span>
<span class="token comment">// targetMap 储存了 target --&gt; Map --&gt; key --&gt; Set --&gt; dep --&gt; effect </span>
<span class="token comment">// 当调用 react.a.b.c.d.e 时 depsMap</span>
<span class="token comment">// {&quot;a&quot; =&gt; Set(1)} --&gt; Set --&gt; effect</span>
<span class="token comment">// {&quot;b&quot; =&gt; Set(1)}</span>
<span class="token comment">// {&quot;c&quot; =&gt; Set(1)}</span>
<span class="token comment">// {&quot;d&quot; =&gt; Set(1)}</span>
<span class="token comment">// {&quot;e&quot; =&gt; Set(1)}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> activeReactiveEffectStack<span class="token punctuation">[</span>activeReactiveEffectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      effect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>trigger 触发器，这个就比较好理解了，拿到target key下的对应的所有 effect，然后遍历执行 effect()</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span> key<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> symbol</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap<span class="token punctuation">:</span> any <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> effects<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap <span class="token operator">&amp;&amp;</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>effect 函数实现</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 暴露的 effect 函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span>
  <span class="token parameter">fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token constant">EMPTY_OBJ</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fn <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>isEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> <span class="token punctuation">(</span>fn <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>raw
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token comment">// 如果不是 lazy，则会立即执行一次</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span>

<span class="token comment">// 创建 effect</span>
<span class="token keyword">function</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>
  <span class="token parameter">fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> any</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span>effect <span class="token keyword">as</span> any<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> any
  effect<span class="token punctuation">.</span>isEffect <span class="token operator">=</span> <span class="token boolean">true</span>
  effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
  effect<span class="token punctuation">.</span>raw <span class="token operator">=</span> fn
  effect<span class="token punctuation">.</span>scheduler <span class="token operator">=</span> options<span class="token punctuation">.</span>scheduler
  effect<span class="token punctuation">.</span>onTrack <span class="token operator">=</span> options<span class="token punctuation">.</span>onTrack
  effect<span class="token punctuation">.</span>onTrigger <span class="token operator">=</span> options<span class="token punctuation">.</span>onTrigger
  effect<span class="token punctuation">.</span>onStop <span class="token operator">=</span> options<span class="token punctuation">.</span>onStop
  effect<span class="token punctuation">.</span>computed <span class="token operator">=</span> options<span class="token punctuation">.</span>computed
  effect<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span>

<span class="token comment">// 执行函数，执行完之后会将储存的 effect 删除</span>
<span class="token comment">// 这是函数 effect 的所有执行，所经历的完整的声明周期</span>
<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">:</span> any<span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> args<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>activeReactiveEffectStack<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      activeReactiveEffectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      activeReactiveEffectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>一口气写了这么多，最后总结一下。在大家看源码的时候，如果发现有哪个地方无从下手的话，可以先从测试用例开始看。因为测试用例可以很清楚的知道这个函数想要达到什么效果，然后从效果上想，为什么这么做，如果我自己写的话应该怎么写，这样一点点就能揣摩出作者的意图了。再根据源码结合自己的想法你就能够学到很多。</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/xuege-learning/dist/assets/js/app.1272842f.js" defer></script><script src="/xuege-learning/dist/assets/js/2.9a27edc2.js" defer></script><script src="/xuege-learning/dist/assets/js/17.7b065a7a.js" defer></script>
  </body>
</html>
