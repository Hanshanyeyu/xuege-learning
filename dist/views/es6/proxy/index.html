<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue3 实现 v-model 原理 | 技匠</title>
    <meta name="description" content="前端知识深入学习">
    
    
    <link rel="preload" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css" as="style"><link rel="preload" href="/xuege-learning/dist/assets/js/app.00484c13.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/2.a1730132.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/8.b97acee4.js" as="script"><link rel="prefetch" href="/xuege-learning/dist/assets/js/10.44e6a869.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/11.87007918.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/12.94e9130c.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/13.ba08e89f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/14.cd9b649f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/3.13006118.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/4.a3c3189d.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/5.e6cec025.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/6.55716d2e.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/7.84565306.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/9.76c7c64c.js">
    <link rel="stylesheet" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xuege-learning/dist/" class="home-link router-link-active"><!----> <span class="site-name">技匠</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>vue3 实现 v-model 原理</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue3-实现-v-model-原理"><a href="#vue3-实现-v-model-原理" aria-hidden="true" class="header-anchor">#</a> vue3 实现 v-model 原理</h1> <blockquote><p>vue3 源码正式放出来了，想必大家也都开始争先恐后的学习 vue3 的知识了。由于 vue3 已经不再支持 v-model 了，而使用 .sync 来代替，但是为了这篇文章可以帮助大家快速了解 vue 的双向绑定实现原理，部分使用了 vue2.x v-model 的实现原理</p></blockquote> <p>proxy 的基础知识，相信大家已经都很了解了，让我们一起来回顾一下吧</p> <h5 id="proxy-是对一个对象的代理，并返回一个已代理的对象，已代理的对象如果发生任何-set-跟-get-的方法都可以被捕获到，我们写一个简单的-🌰"><a href="#proxy-是对一个对象的代理，并返回一个已代理的对象，已代理的对象如果发生任何-set-跟-get-的方法都可以被捕获到，我们写一个简单的-🌰" aria-hidden="true" class="header-anchor">#</a> proxy 是对一个对象的代理，并返回一个已代理的对象，已代理的对象如果发生任何 set 跟 get 的方法都可以被捕获到，我们写一个简单的 🌰</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> handers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当对 observed.a 进行取值时会触发</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当对 observed.a 进行赋值时会触发</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 还有一些额外的参数如 has 等，这里用不到，就不多说了</span>
  <span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handers<span class="token punctuation">)</span>
</code></pre></div><p>这样我们就可以对 target 对象设置了一层代理，当我们对 target 进行取赋值操作的时候就可以接可以截获到它的行为了，但是如果你以为就只有这么简单你就错了。</p> <p>我们把 target 改写成多层嵌套</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">...</span>

<span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handers<span class="token punctuation">)</span>
</code></pre></div><h5 id="我们再获取-observed-a-b-2-的时候，get-方法取到的是-a-的值-b-1-而-set-并不会触发。这也说明了-proxy-只能代理一层对象，不能深层代理！"><a href="#我们再获取-observed-a-b-2-的时候，get-方法取到的是-a-的值-b-1-而-set-并不会触发。这也说明了-proxy-只能代理一层对象，不能深层代理！" aria-hidden="true" class="header-anchor">#</a> 我们再获取 observed.a.b = 2 的时候，get 方法取到的是 a 的值 { b: 1 }, 而 set 并不会触发。这也说明了 proxy 只能代理一层对象，不能深层代理！</h5> <p>那么我们需要监听到嵌套的对象怎么办？</p> <p>其实这个也不难，就是在 get 的时候判断一下得到的值是不是对象，如果是对象的话就 在对它代理一层，直到最后一层，全部代理完为止，这里就需要一个递归函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> handers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们就可以对目标函数内部的所有属性进行深层监听了，但是这样还是不够，因为我们每次取值的时候都会设置代理这样会导致代码无限循环-&gt;死循环，所以我们需要做一层判断，如果已经设置了代理的或这已经是代理的对象就不需要在此设置代理了。又因为我们要储存对象的映射，所以需要使用map函数。下面是reactive完整的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> rawToReactive<span class="token punctuation">:</span> WeakMap<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> reactiveToRaw<span class="token punctuation">:</span> WeakMap<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 已经有代理</span>
  <span class="token keyword">let</span> observed <span class="token operator">=</span> rawToReactive<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>observed <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> observed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 这个数据已经是代理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reactiveToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string<span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string<span class="token punctuation">,</span> value<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将新值赋值</span>
      target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token comment">// 通知所有订阅者触发更新</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 严格模式下需要设置返回值，否则会报错</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回代理监听对象</span>
  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> handler <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rawToReactive<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> observed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  reactiveToRaw<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> observed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="定义watcher-用来作为-compile-跟-reactive-的桥梁，-跟-vue3-的实现可能不一样"><a href="#定义watcher-用来作为-compile-跟-reactive-的桥梁，-跟-vue3-的实现可能不一样" aria-hidden="true" class="header-anchor">#</a> 定义watcher 用来作为 compile 跟 reactive 的桥梁， 跟 vue3 的实现可能不一样</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 收集watcher依赖</span>
<span class="token keyword">const</span> Dep<span class="token punctuation">:</span> Dep <span class="token operator">=</span> <span class="token punctuation">{</span>
  deps<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">watcher<span class="token punctuation">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// observer跟compile的桥梁，在编译时添加watcher，在数据更新时触发update更新视图</span>
<span class="token keyword">function</span> <span class="token function">_watcher</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">:</span> any<span class="token punctuation">,</span> attr<span class="token punctuation">:</span> string<span class="token punctuation">,</span> data<span class="token punctuation">:</span> any<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Watcher <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    node<span class="token punctuation">,</span>
    attr<span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    key<span class="token punctuation">,</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 逐层取值</span>
      <span class="token keyword">const</span> mutationKeys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mutationKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> d<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        mutationKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>d <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>d <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="接下来是编译模板"><a href="#接下来是编译模板" aria-hidden="true" class="header-anchor">#</a> 接下来是编译模板</h4> <p><em>这里只是模拟编译，真正的编译不是这样的</em></p> <p>获取到模板上的 v-model 、 v-bind 属性，获取到绑定的属性。当数据发生变化时，更新视图（这里会在trigger进行触发），当视图改变数据时修改数据（为了简单，通过eval函数实现），具体代码如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译模板</span>
<span class="token keyword">function</span> <span class="token function">_compile</span><span class="token punctuation">(</span><span class="token parameter">nodes<span class="token punctuation">:</span> any<span class="token punctuation">,</span> $data<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token operator">...</span>nodes<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> theNode <span class="token operator">=</span> nodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取到 input标签下的 v-model 属性，并添加watcher</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>theNode<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'INPUT'</span> <span class="token operator">&amp;&amp;</span> theNode<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'v-model'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> theNode<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'v-model'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">_watcher</span><span class="token punctuation">(</span>theNode<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> $data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 监听input事件</span>
      theNode<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mutationKeys <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mutationKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$data.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>theNode<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        $data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> theNode<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取 v-bind 属性，并添加watcher</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>theNode<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'v-bind'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> theNode<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'v-bind'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">_watcher</span><span class="token punctuation">(</span>theNode<span class="token punctuation">,</span> <span class="token string">'innerHTML'</span><span class="token punctuation">,</span> $data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span>$data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>trigger 对依赖进行触发</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span> key<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> symbol</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dep<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使用效果"><a href="#使用效果" aria-hidden="true" class="header-anchor">#</a> 使用效果</h4> <h4 id="废话不多说。直接上代码！"><a href="#废话不多说。直接上代码！" aria-hidden="true" class="header-anchor">#</a> 废话不多说。直接上代码！</h4> <p>假设我们有一个模板是这样的，接下来我们在这个模板的 id=&quot;my-app&quot; 元素内实现双向绑定</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;my-app&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>h1 v<span class="token operator">-</span>bind<span class="token operator">=</span><span class="token string">&quot;a&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">&quot;a&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div><p>vue3 中 new Vue 已经被 createApp 所代替，reactive 是反应原理，可以抽出来单独使用，vue3 外漏了所有内部的 api，都可以在外部使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createApp<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./vue.ts'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> react <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      a<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        b<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          c<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            d<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              e<span class="token punctuation">:</span> <span class="token number">111</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 测试异步反应</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      react<span class="token punctuation">.</span>a<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c<span class="token punctuation">.</span>d<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> react<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token string">'#my-app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/xuege-learning/dist/assets/js/app.00484c13.js" defer></script><script src="/xuege-learning/dist/assets/js/2.a1730132.js" defer></script><script src="/xuege-learning/dist/assets/js/8.b97acee4.js" defer></script>
  </body>
</html>
