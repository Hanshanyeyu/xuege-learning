<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>写给新手前端的各种文件上传攻略，从小图片到大文件断点续传 | 技匠</title>
    <meta name="description" content="前端知识深入学习">
    
    
    <link rel="preload" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css" as="style"><link rel="preload" href="/xuege-learning/dist/assets/js/app.2fd7c63d.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/2.304eb466.js" as="script"><link rel="preload" href="/xuege-learning/dist/assets/js/30.0458713b.js" as="script"><link rel="prefetch" href="/xuege-learning/dist/assets/js/10.ce208702.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/11.dccc70ad.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/12.a01dc21f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/13.be88cd92.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/14.62ffab80.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/15.4f224b22.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/16.431e0be0.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/17.285c1804.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/18.50ec12ca.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/19.84104556.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/20.cac591c5.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/21.eff5804e.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/22.8e9b71e8.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/23.f483a31f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/24.cfddc827.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/25.12bf2e52.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/26.3c41a385.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/27.45ef8e6f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/28.c37eb3bf.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/29.34f4280f.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/3.16d19a3b.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/31.3fbfeaa2.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/32.b50d55e5.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/33.d31d3f91.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/34.b0ffa556.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/35.b080b67a.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/36.e45d5e9c.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/37.095bd4d5.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/4.3f2d9650.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/5.19d8483c.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/6.4148b401.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/7.117a24c3.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/8.9f62239a.js"><link rel="prefetch" href="/xuege-learning/dist/assets/js/9.83ea6150.js">
    <link rel="stylesheet" href="/xuege-learning/dist/assets/css/0.styles.2ac2341d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xuege-learning/dist/" class="home-link router-link-active"><!----> <span class="site-name">技匠</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xuege-learning/dist/" class="nav-link">Home</a></div><div class="nav-item"><a href="/xuege-learning/dist/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/chinese.html" class="nav-link">Chinese</a></li><li class="dropdown-item"><!----> <a href="/xuege-learning/dist/language/english.html" class="nav-link">English</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/luoxue-victor/xuege-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>写给新手前端的各种文件上传攻略，从小图片到大文件断点续传</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#自测读不读" class="sidebar-link">自测读不读</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#原理概述" class="sidebar-link">原理概述</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#文件上传接口" class="sidebar-link">文件上传接口</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#多文件上传" class="sidebar-link">多文件上传</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#局部刷新-iframe" class="sidebar-link">局部刷新 \- iframe</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#无刷新上传" class="sidebar-link">无刷新上传</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#多文件，单进度" class="sidebar-link">多文件，单进度</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#多文件上传-预览-取消" class="sidebar-link">多文件上传+预览+取消</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#问题1" class="sidebar-link">问题1</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#问题2" class="sidebar-link">问题2</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#拖拽上传" class="sidebar-link">拖拽上传</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#剪贴板上传" class="sidebar-link">剪贴板上传</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#问题1-2" class="sidebar-link">问题1</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#问题2-2" class="sidebar-link">问题2</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#大文件上传-分片" class="sidebar-link">大文件上传-分片</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#大文件上传-断点续传" class="sidebar-link">大文件上传-断点续传</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#方法1" class="sidebar-link">方法1</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#方法2-断点续传" class="sidebar-link">方法2 - 断点续传</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#node-端上传图片" class="sidebar-link">node 端上传图片</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#其他" class="sidebar-link">其他</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#最后有两件小事" class="sidebar-link">最后有两件小事</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/xuege-learning/dist/views/tools/input/%E5%86%99%E7%BB%99%E6%96%B0%E6%89%8B%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%94%BB%E7%95%A5%EF%BC%8C%E4%BB%8E%E5%B0%8F%E5%9B%BE%E7%89%87%E5%88%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="写给新手前端的各种文件上传攻略，从小图片到大文件断点续传"><a href="#写给新手前端的各种文件上传攻略，从小图片到大文件断点续传" aria-hidden="true" class="header-anchor">#</a> 写给新手前端的各种文件上传攻略，从小图片到大文件断点续传</h1> <p>本文来自掘金作者： zz_jesse</p> <p>地址 https://juejin.im/user/5788b15cc4c971005ed26744</p> <h2 id="自测读不读"><a href="#自测读不读" aria-hidden="true" class="header-anchor">#</a> 自测读不读</h2> <p>以下是本文所涉及到的知识点，break or continue ?</p> <ul><li>文件上传原理</li> <li>最原始的文件上传</li> <li>使用 koa2 作为服务端写一个文件上传接口</li> <li>单文件上传和上传进度</li> <li>多文件上传和上传进度</li> <li>拖拽上传</li> <li>剪贴板上传</li> <li>大文件上传之分片上传</li> <li>大文件上传之断点续传</li> <li>node 端文件上传</li></ul> <h2 id="原理概述"><a href="#原理概述" aria-hidden="true" class="header-anchor">#</a> 原理概述</h2> <p>原理很简单，就是根据 http 协议的规范和定义，完成请求消息体的封装和消息体的解析，然后将二进制内容保存到文件。</p> <p>我们都知道如果要上传一个文件，需要把 form 标签的<code>enctype</code>设置为<code>multipart/form-data</code>,同时<code>method</code>必须为<code>post</code>方法。</p> <p>那么<code>multipart/form-data</code>表示什么呢？</p> <blockquote><p>multipart互联网上的混合资源，就是资源由多种元素组成，form-data表示可以使用HTML Forms 和 POST 方法上传文件，具体的定义可以参考RFC 7578。</p></blockquote> <p><code>multipart/form-data</code> 结构</p> <p>看下 http 请求的消息体</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3d4c4d605f53?imageslim" alt=""></p> <ul><li>请求头：</li></ul> <p><code>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryDCntfiXcSkPhS4PN</code> 表示本次请求要上传文件，其中boundary表示分隔符，如果要上传多个表单项，就要使用boundary分割，每个表单项由———XXX开始，以———XXX结尾。</p> <ul><li>消息体- Form Data 部分</li></ul> <p>每一个表单项又由<code>Content-Type</code>和<code>Content-Disposition</code>组成。</p> <p><code>Content-Disposition: form-data</code> 为固定值，表示一个表单元素，<code>name</code> 表示表单元素的 名称，回车换行后面就是<code>name</code>的值，如果是上传文件就是文件的二进制内容。</p> <p><code>Content-Type</code>：表示当前的内容的 MIME 类型，是图片还是文本还是二进制数据。</p> <p><strong>解析</strong></p> <p>客户端发送请求到服务器后，服务器会收到请求的消息体，然后对消息体进行解析，解析出哪是普通表单哪些是附件。</p> <p>可能大家马上能想到通过正则或者字符串处理分割出内容，不过这样是行不通的，二进制<code>buffer</code>转化为<code>string</code>,对字符串进行截取后，其索引和字符串是不一致的，所以结果就不会正确，除非上传的就是字符串。</p> <p>不过一般情况下不需要自行解析，目前已经有很成熟的三方库可以使用。</p> <p>至于如何解析，这个也会占用很大篇幅，后面的文章在详细说。</p> <h1 id="最原始的文件上传"><a href="#最原始的文件上传" aria-hidden="true" class="header-anchor">#</a> 最原始的文件上传</h1> <p><strong>使用 form 表单上传文件</strong></p> <p>在 <code>ie</code>时代，如果实现一个无刷新的文件上传那可是费老劲了，大部分都是用 iframe 来实现局部刷新或者使用 flash 插件来搞定，在那个时代 ie 就是最好用的浏览器（别无选择）。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3b9b353b4bc7?imageslim" alt=""></p> <p>这种方式上传文件，不需要 js ，而且没有兼容问题，所有浏览器都支持，就是体验很差，导致页面刷新，页面其他数据丢失。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://localhost:8100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>选择文件:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>input 必须设置 name 属性，否则数据无法发送 \n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>标题:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="文件上传接口"><a href="#文件上传接口" aria-hidden="true" class="header-anchor">#</a> 文件上传接口</h2> <p>服务端文件的保存基于现有的库<code>koa-body</code>结合 <code>koa2</code>实现服务端文件的保存和数据的返回。</p> <p>在项目开发中，文件上传本身和业务无关，代码基本上都可通用。</p> <p>在这里我们使用<code>koa-body</code>库来实现解析和文件的保存。</p> <p><code>koa-body</code> 会自动保存文件到系统临时目录下，也可以指定保存的文件路径。</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/7/16da5a50d29b54b3?imageslim" alt=""></p> <p>然后在后续中间件内得到已保存的文件的信息，再做二次处理。</p> <ul><li><code>ctx.request.files.f1</code> 得到文件信息，<code>f1</code>为<code>input file</code> 标签的 <code>name</code></li> <li>获得文件的扩展名，重命名文件</li></ul> <p><code>NODE</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
  * 服务入口
  */</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> koaStatic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> koaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//文件保存库</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token string">'8100'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> uploadHost<span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/uploads/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaBody</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  formidable<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置文件的默认保存目录，不设置则保存在系统临时目录下  os</span>
    uploadDir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../static/uploads'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  multipart<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// 开启文件上传，默认是关闭</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//开启静态文件访问</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaStatic</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../static'</span><span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//文件二次处理，修改名称</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> file <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>f1<span class="token punctuation">;</span><span class="token comment">//得道文件对象</span>
  <span class="token keyword">var</span> path <span class="token operator">=</span> file<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
  <span class="token keyword">var</span> fname <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//原文件名称</span>
  <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path<span class="token operator">+</span>fname<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//得到扩展名</span>
    <span class="token keyword">var</span> extArr <span class="token operator">=</span> fname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ext <span class="token operator">=</span> extArr<span class="token punctuation">[</span>extArr<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path<span class="token operator">+</span><span class="token string">'.'</span><span class="token operator">+</span>ext<span class="token punctuation">;</span>
    <span class="token comment">//重命名文件</span>
    fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> nextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//以 json 形式输出上传文件地址</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{
    &quot;fileUrl&quot;:&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadHost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextPath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>nextPath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;
  }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
  * http server
  */</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'demo1 server start ......   '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo1</p> <h2 id="多文件上传"><a href="#多文件上传" aria-hidden="true" class="header-anchor">#</a> 多文件上传</h2> <p>在 <code>ie</code> 时代的多文件上传是需要创建多个 <code>input file</code> 标签，现在 <code>html5</code>只需要一个标签加个属性就搞定了,<code>file</code> 标签开启<code>multiple</code>。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3bc9abab6d30?imageslim" alt=""></p> <p><code>HTML</code></p> <div class="language-html extra-class"><pre class="language-html"><code>//设置 multiple属性
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">/&gt;</span></span> 
</code></pre></div><p><code>NODE</code></p> <p>服务端也需要进行简单的调整，由单文件对象变为多文件数组，然后进行遍历处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//二次处理文件，修改名称</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> files <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>f1<span class="token punctuation">;</span><span class="token comment">// 多文件， 得到上传文件的数组</span>
  <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">//遍历处理</span>
  files <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> item<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token keyword">var</span> fname <span class="token operator">=</span> item<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//原文件名称</span>
    <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path <span class="token operator">+</span> fname<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//得到扩展名</span>
      <span class="token keyword">var</span> extArr <span class="token operator">=</span> fname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> ext <span class="token operator">=</span> extArr<span class="token punctuation">[</span>extArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> ext<span class="token punctuation">;</span>
      <span class="token comment">//重命名文件</span>
      fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> nextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">//文件可访问路径放入数组</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>uploadHost<span class="token operator">+</span> nextPath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>nextPath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//输出 json 结果</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{
    &quot;fileUrl&quot;:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
  }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo2</p> <h2 id="局部刷新-iframe"><a href="#局部刷新-iframe" aria-hidden="true" class="header-anchor">#</a> 局部刷新 - iframe</h2> <p>这里说的是在 <code>ie</code> 时代的上传文件局部刷新，借助 iframe 实现。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3bde37cca831?imageslim" alt=""></p> <ul><li>局部刷新</li></ul> <p>页面内放一个隐藏的 <code>iframe</code>，或者使用 <code>js</code> 动态创建，指定 <code>form</code> 表单的 <code>target</code> 属性值为<code>iframe</code>标签 的 <code>name</code> 属性值，这样 <code>form</code> 表单的 <code>shubmit</code> 行为的跳转就会在 <code>iframe</code> 内完成，整体页面不会刷新。</p> <ul><li>拿到接口数据</li></ul> <p>然后为 <code>iframe</code> 添加<code>load</code>事件，得到 <code>iframe</code> 的页面内容，将结果转换为 <code>JSON</code> 对象，这样就拿到了接口的数据</p> <p><code>HTML</code></p> <div class="language-HTML extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>temp-iframe<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>temp-iframe<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>temp-iframe<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://localhost:8100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    选择文件(可多选):
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span> input 必须设置 name 属性，否则数据无法发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    标题：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上 传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'temp-iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> result <span class="token operator">=</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
      <span class="token comment">//接口数据转换为 JSON 对象</span>
      <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>NODE</code></p> <p>服务端代码不需要改动，略.</p> <p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo3</p> <h2 id="无刷新上传"><a href="#无刷新上传" aria-hidden="true" class="header-anchor">#</a> 无刷新上传</h2> <p>无刷新上传文件肯定要用到<code>XMLHttpRequest</code>,在 <code>ie</code> 时代也有这个对象，单只 支持文本数据的传输，无法用来读取和上传二进制数据。</p> <p>现在已然升级到了<code>XMLHttpRequest2</code>，较1版本有非常大的升级，首先就是可以读取和上传二进制数据，可以使用·FormData·对象管理表单数据。</p> <p>当然也可使用 <code>fetch</code> 进行上传。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3bf40a6ae554?imageslim" alt=""></p> <p><code>HTML</code></p> <div class="language-HTML extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  选择文件(可多选):
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上 传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>JS xhr</code></p> <div class="language-JS xhr extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获得文件列表，注意这里不是数组，而是对象</span>
    <span class="token keyword">var</span> fileList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//多文件上传需要遍历添加到 fromdata 对象</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> fileList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持多文件上传</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8100/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送时  Content-Type默认就是: multipart/form-data; </span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state change'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//绑定提交事件</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>submitUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><code>JS Fetch</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> fd
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo4</p> <h2 id="多文件，单进度"><a href="#多文件，单进度" aria-hidden="true" class="header-anchor">#</a> 多文件，单进度</h2> <p>借助<code>XMLHttpRequest2</code>的能力，实现多个文件或者一个文件的上传进度条的显示。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3bff57634139?imageslim" alt=""></p> <p><code>说明</code></p> <ul><li>页面内增加一个用于显示进度的标签 <code>div.progress</code></li> <li><code>js</code> 内处理增加进度处理的监听函数<code>xhr.upload.onprogress</code></li> <li><code>event.lengthComputable</code>这是一个状态，表示发送的长度有了变化，可计算</li> <li><code>event.loaded</code>表示发送了多少字节</li> <li><code>event.total</code>表示文件总大小</li> <li>根据<code>event.loaded</code>和<code>event.total</code>计算进度，渲染<code>div.progress</code></li></ul> <blockquote><p>PS 特别提醒</p></blockquote> <p><code>xhr.upload.onprogress</code>要写在<code>xhr.send</code>方法前面，否则<code>event.lengthComputable</code>状态不会改变，只有在最后一次才能获得，也就是<code>100%</code>的时候.</p> <p><code>HTML</code></p> <div class="language-HTML extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  选择文件(可多选):
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>progress<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>red<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上 传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>JS</code></p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> progressSpan <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>firstElementChild<span class="token punctuation">;</span>
    <span class="token keyword">var</span> fileList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">;</span>
    progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token operator">=</span><span class="token string">'0'</span><span class="token punctuation">;</span>
    progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> fileList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持多文件上传</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://10.70.65.235:8100/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state change'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    xhr<span class="token punctuation">.</span>onprogress<span class="token operator">=</span>updateProgress<span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>onprogress <span class="token operator">=</span> updateProgress<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> completedPercent <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>loaded <span class="token operator">/</span> event<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token operator">=</span> completedPercent<span class="token operator">+</span><span class="token string">'%'</span><span class="token punctuation">;</span>
        progressSpan<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span>completedPercent<span class="token operator">+</span><span class="token string">'%'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>completedPercent<span class="token operator">&gt;</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//进度条变色</span>
          progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已上传'</span><span class="token punctuation">,</span>completedPercent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//注意 send 一定要写在最下面，否则 onprogress 只会执行最后一次 也就是100%的时候</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送时  Content-Type默认就是: multipart/form-data; </span>
  <span class="token punctuation">}</span>
  <span class="token comment">//绑定提交事件</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>submitUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo5</p> <h2 id="多文件上传-预览-取消"><a href="#多文件上传-预览-取消" aria-hidden="true" class="header-anchor">#</a> 多文件上传+预览+取消</h2> <p>上一个栗子的多文件上传只有一个进度条，有些需求可能会不大一样，需要观察到每个文件的上传进度，并且可以终止上传。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3c15b6fe32aa?imageslim" alt=""></p> <p><code>说明</code></p> <ul><li>为了预览的需要，我们这里选择上传图片文件，其他类型的也一样，只是预览不方便</li> <li>页面内增加一个多图预览的容器<code>div.img-box</code></li> <li>根据选择的文件信息动态创建所属的预览区域和进度条以及取消按钮</li> <li>为取消按钮绑定事件，调用<code>xhr.abort();</code>终止上传</li> <li>使用<code>window.URL.createObjectURL</code>预览图片，在图片加载成功后需要清除使用的内存<code>window.URL.revokeObjectURL(this.src);</code></li></ul> <p><code>HTML</code></p> <div class="language-HTML extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  选择文件(可多选):
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>addfile<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>添加文件
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>f1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>img-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上 传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>JS</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token comment">//更改网络 为慢3g，就可以比较明显的看到进度条了</span>
  <span class="token keyword">var</span> fileMaxCount<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> imgBox <span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'img-box'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> willUploadFile<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//保存待上传的文件以及相关附属信息</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> fileList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>willUploadFile<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> fileMaxCount <span class="token operator">||</span> fileList<span class="token punctuation">.</span>length<span class="token operator">&gt;</span>fileMaxCount <span class="token operator">||</span> <span class="token punctuation">(</span>willUploadFile<span class="token punctuation">.</span>length<span class="token operator">+</span> fileList<span class="token punctuation">.</span>length<span class="token operator">&gt;</span>fileMaxCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'最多只能上传'</span> <span class="token operator">+</span> fileMaxCount <span class="token operator">+</span> <span class="token string">'张图'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> f <span class="token operator">=</span> fileList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//先预览图片</span>
      <span class="token keyword">var</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> item <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> progress <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      progress<span class="token punctuation">.</span>className<span class="token operator">=</span><span class="token string">'progress'</span><span class="token punctuation">;</span>
      progress<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;span class=&quot;red&quot;&gt;&lt;/span&gt;&lt;button type=&quot;button&quot;&gt;Abort&lt;/button&gt;'</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>className<span class="token operator">=</span><span class="token string">'item'</span><span class="token punctuation">;</span>
      img<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
      img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//显示要是否这块儿内存</span>
        window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      item<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      imgBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

      willUploadFile<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        file<span class="token punctuation">:</span>f<span class="token punctuation">,</span>
        item<span class="token punctuation">,</span>
        progress
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">xhrSend</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>file<span class="token punctuation">,</span> progress<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> progressSpan <span class="token operator">=</span> progress<span class="token punctuation">.</span>firstElementChild<span class="token punctuation">;</span>
    <span class="token keyword">var</span> btnCancel <span class="token operator">=</span> progress<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    btnCancel<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnCancel<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>xhr <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>readyState<span class="token operator">!==</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//取消上传</span>
        xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token operator">=</span><span class="token string">'0'</span><span class="token punctuation">;</span>
    progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8100/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state change'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//调用 abort 后，state 立即变成了4,并不会变成0</span>
      <span class="token comment">//增加自定义属性  xhr.uploaded</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span>  xhr<span class="token punctuation">.</span>uploaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//alert('上传成功');</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    xhr<span class="token punctuation">.</span>onprogress<span class="token operator">=</span>updateProgress<span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>onprogress <span class="token operator">=</span> updateProgress<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> completedPercent <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>loaded <span class="token operator">/</span> event<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token operator">=</span> completedPercent<span class="token operator">+</span><span class="token string">'%'</span><span class="token punctuation">;</span>
        progressSpan<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span>completedPercent<span class="token operator">+</span><span class="token string">'%'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>completedPercent<span class="token operator">&gt;</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//进度条变色</span>
          progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>completedPercent<span class="token operator">&gt;=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          xhr<span class="token punctuation">.</span>uploaded<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已上传'</span><span class="token punctuation">,</span>completedPercent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//注意 send 一定要写在最下面，否则 onprogress 只会执行最后一次 也就是100%的时候</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送时  Content-Type默认就是: multipart/form-data; </span>
    <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//文件上传</span>
  <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token parameter">willFiles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>willFiles<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//遍历文件信息进行上传</span>
    willFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">xhrSend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          file<span class="token punctuation">:</span>item<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
          progress<span class="token punctuation">:</span>item<span class="token punctuation">.</span>progress
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//绑定提交事件</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">submitUpload</span><span class="token punctuation">(</span>willUploadFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h2 id="问题1"><a href="#问题1" aria-hidden="true" class="header-anchor">#</a> 问题1</h2> <p>这里没有做上传的并发控制，可以通过控制同时可上传文件的个数（这里控制为最多6个）或者上传的时候做好并发处理，也就是同时只能上传 X 个文件。</p> <h2 id="问题2"><a href="#问题2" aria-hidden="true" class="header-anchor">#</a> 问题2</h2> <p>在测试过程中，取消请求的方法<code>xhr.abort()</code>调用后，<code>xhr.readyState</code>会立即变为<code>4</code>,而不是<code>0</code>，所以这里需要做容错处理。</p> <p>MDN 上说是0.</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd29041bd33cdd?imageslim" alt=""></p> <p>如果大家有不同的结果，欢迎留言。</p> <p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo11</p> <h2 id="拖拽上传"><a href="#拖拽上传" aria-hidden="true" class="header-anchor">#</a> 拖拽上传</h2> <p><code>html5</code>的出现，让拖拽上传交互成为可能，现在这样的体验也屡见不鲜。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3c296abb9562?imageslim" alt=""></p> <p><code>说明</code></p> <ul><li>定义一个允许拖放文件的区域<code>div.drop-box</code></li> <li>取消<code>drop</code> 事件的默认行为<code>e.preventDefault();</code>，不然浏览器会直接打开文件</li> <li>为拖拽区域绑定事件,鼠标在拖拽区域上 <code>dragover</code>, 鼠标离开拖拽区域<code>dragleave</code>, 在拖拽区域上释放文件<code>drop</code></li> <li><code>drop</code>事件内获得文件信息<code>e.dataTransfer.files</code></li></ul> <p><code>HTML</code></p> <div class="language-HTML extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>drop-box<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>drop-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  拖动文件到这里,开始上传
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上 传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>JS</code></p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">var</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drop-box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//禁用浏览器的拖放默认行为</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'drop'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'document drog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//设置拖拽事件</span>
  <span class="token keyword">function</span> <span class="token function">openDropEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;dragover&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'elemenet dragover'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'over'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;dragleave&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'elemenet dragleave'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'over'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;drop&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//取消浏览器默认拖拽效果</span>

      <span class="token keyword">var</span> fileList <span class="token operator">=</span> e<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">;</span> <span class="token comment">//获取拖拽中的文件对象</span>
      <span class="token keyword">var</span> len<span class="token operator">=</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token comment">//用来获取文件的长度（其实是获得文件数量）</span>
      
      <span class="token comment">//检测是否是拖拽文件到页面的操作</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'over'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'over'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>willUploadFileList<span class="token operator">=</span>fileList<span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">openDropEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> fileList <span class="token operator">=</span> window<span class="token punctuation">.</span>willUploadFileList<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> fileList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持多文件上传</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8100/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//绑定提交事件</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>submitUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo7</p> <h2 id="剪贴板上传"><a href="#剪贴板上传" aria-hidden="true" class="header-anchor">#</a> 剪贴板上传</h2> <p>掘金的写文编辑器是支持粘贴上传图片的，比如我从磁盘粘贴或者从网页上右键复制图片。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3c3dc32af3fc?imageslim" alt=""></p> <p><code>说明</code></p> <ul><li>页面内增加一个可编辑的编辑区域<code>div.editor-box</code>,开启<code>contenteditable</code></li> <li>为<code>div.editor-box</code>绑定<code>paste</code>事件</li> <li>处理<code>paste</code> 事件，从<code>event.clipboardData || window.clipboardData</code>获得数据</li> <li>将数据转换为文件<code>items[i].getAsFile()</code></li> <li>实现在编辑区域的光标处插入内容 <code>insertNodeToEditor</code> 方法</li></ul> <h2 id="问题1-2"><a href="#问题1-2" aria-hidden="true" class="header-anchor">#</a> 问题1</h2> <p>测试中发现复制多个文件无效，只有最后一个文件上传，在掘金的编辑器里也同样存在，在坐有知道原因的可以留言说下。</p> <h2 id="问题2-2"><a href="#问题2-2" aria-hidden="true" class="header-anchor">#</a> 问题2</h2> <p><code>mac</code>系统可以支持从磁盘复制文件后上传，<code>windows</code> 系统测试未通过，剪贴板的数据未拿到。</p> <p><code>HTML</code></p> <div class="language-HTML extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>editor-box<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>editor-box<span class="token punctuation">&quot;</span></span> <span class="token attr-name">contenteditable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
  可以直接粘贴图片到这里直接上传
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>JS</code></p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token comment">//光标处插入 dom 节点</span>
<span class="token keyword">function</span>  <span class="token function">insertNodeToEditor</span><span class="token punctuation">(</span><span class="token parameter">editor<span class="token punctuation">,</span>ele</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//插入dom 节点</span>
  <span class="token keyword">var</span> range<span class="token punctuation">;</span><span class="token comment">//记录光标位置对象</span>
  <span class="token keyword">var</span> node <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>anchorNode<span class="token punctuation">;</span>
  <span class="token comment">// 这里判断是做是否有光标判断，因为弹出框默认是没有的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    range <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取光标起始位置</span>
    range<span class="token punctuation">.</span><span class="token function">insertNode</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在光标位置插入该对象</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    editor<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'editor-box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//绑定paste事件</span>
box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clipboardData <span class="token operator">||</span> window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> items <span class="token operator">=</span> data<span class="token punctuation">.</span>items<span class="token punctuation">;</span>
  <span class="token keyword">var</span> fileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存储文件数据</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">&amp;&amp;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检索剪切板items</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fileList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span>willUploadFileList <span class="token operator">=</span> fileList<span class="token punctuation">;</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻止默认行为</span>

  <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> fileList <span class="token operator">=</span> window<span class="token punctuation">.</span>willUploadFileList<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> fileList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持多文件上传</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8100/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>src<span class="token operator">=</span> obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token operator">=</span><span class="token string">'100px'</span><span class="token punctuation">;</span>
        <span class="token function">insertNodeToEditor</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// alert('上传成功');</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/blob/master/src/upfiles-demo/demo8/</p> <h2 id="大文件上传-分片"><a href="#大文件上传-分片" aria-hidden="true" class="header-anchor">#</a> 大文件上传-分片</h2> <p>在 <code>ie</code> 时代由于无法使用<code>xhr</code>上传二进制数据，上传大文件需要借助浏览器插件来完成。 现在来看实现大文件上传简直soeasy。</p> <p>如果太大的文件，比如一个视频1g 2g那么大，直接采用上面的栗子中的方法上传可能会出链接现超时的情况，而且也会超过服务端允许上传文件的大小限制，所以解决这个问题我们可以将文件进行分片上传，每次只上传很小的一部分 比如2M。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3e61dd505d27?imageslim" alt=""></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3c562bd4c801?imageslim" alt=""></p> <p><code>说明</code></p> <p>相信大家都对<code>Blob</code> 对象有所了解，它表示原始数据,也就是二进制数据，同时提供了对数据截取的方法<code>slice</code>,而 <code>File</code> 继承了<code>Blob</code>的功能，所以可以直接使用此方法对数据进行分段截图。</p> <ul><li>把大文件进行分段 比如2M，发送到服务器携带一个标志，暂时用当前的时间戳，用于标识一个完整的文件</li> <li>服务端保存各段文件</li> <li>浏览器端所有分片上传完成，发送给服务端一个合并文件的请求</li> <li>服务端根据文件标识、类型、各分片顺序进行文件合并</li> <li>删除分片文件</li></ul> <p><code>HTML</code></p> <p>代码略，只需要一个 <code>input file</code> 标签。</p> <p><code>JS</code></p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token comment">//分片逻辑  像操作字符串一样</span>
<span class="token keyword">var</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  end<span class="token operator">+=</span>chunkSize<span class="token punctuation">;</span>
  <span class="token keyword">var</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
  start<span class="token operator">+=</span>chunkSize<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>blob<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//截取的数据为空 则结束</span>
    <span class="token comment">//拆分结束</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存分段数据</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> chunkSize<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment">//分片大小 2M</span>
  <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> chunks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//保存分片数据</span>
    token <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//时间戳</span>
    name <span class="token operator">=</span>file<span class="token punctuation">.</span>name<span class="token punctuation">,</span>chunkCount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>sendChunkCount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">//拆分文件 像操作字符串一样</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token operator">&gt;</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//拆分文件</span>
    <span class="token keyword">var</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      end<span class="token operator">+=</span>chunkSize<span class="token punctuation">;</span>
      <span class="token keyword">var</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
      start<span class="token operator">+=</span>chunkSize<span class="token punctuation">;</span>
      
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>blob<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//截取的数据为空 则结束</span>
        <span class="token comment">//拆分结束</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存分段数据</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  chunkCount<span class="token operator">=</span>chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token comment">//分片的个数 </span>
  
  <span class="token comment">//没有做并发限制，较大文件导致并发过多，tcp 链接被占光 ，需要做下并发控制，比如只有4个在请求在发送</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> chunkCount<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">xhrSend</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sendChunkCount<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>sendChunkCount<span class="token operator">===</span>chunkCount<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//上传完成，发送合并请求</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上传完成，发送合并请求'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> formD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span><span class="token string">'merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'chunkCount'</span><span class="token punctuation">,</span>chunkCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">xhrSend</span><span class="token punctuation">(</span>formD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">xhrSend</span><span class="token punctuation">(</span><span class="token parameter">fd<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8100/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state change'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送</span>
<span class="token punctuation">}</span>

<span class="token comment">//绑定提交事件</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>submitUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><code>NODE</code></p> <p>服务端需要做一些改动，保存分片文件、合并分段文件、删除分段文件。</p> <p><strong>PS</strong></p> <p>合并文件这里使用 <code>stream pipe</code> 实现，这样更节省内存，边读边写入，占用内存更小，效率更高，代码见<code>fnMergeFile</code>方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//二次处理文件，修改名称</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">var</span> files <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files <span class="token operator">?</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>f1<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//得到上传文件的数组</span>
  <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> fileToken <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>token<span class="token punctuation">;</span><span class="token comment">// 文件标识</span>
  <span class="token keyword">var</span> fileIndex<span class="token operator">=</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>index<span class="token punctuation">;</span><span class="token comment">//文件顺序</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>files <span class="token operator">&amp;&amp;</span>  <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//单文件上传容错</span>
    files<span class="token operator">=</span><span class="token punctuation">[</span>files<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  files <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> item<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token keyword">var</span> fname <span class="token operator">=</span> item<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//原文件名称</span>
    <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> fileIndex <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> fileToken<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//得到扩展名</span>
      <span class="token keyword">var</span> extArr <span class="token operator">=</span> fname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> ext <span class="token operator">=</span> extArr<span class="token punctuation">[</span>extArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//var nextPath = path + '.' + ext;</span>
      <span class="token comment">//重命名文件</span>
      fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> nextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>uploadHost<span class="token operator">+</span>nextPath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>nextPath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>type<span class="token operator">===</span><span class="token string">'merge'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//合并分片文件</span>
    <span class="token keyword">var</span> filename <span class="token operator">=</span> body<span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
    chunkCount <span class="token operator">=</span> body<span class="token punctuation">.</span>chunkCount<span class="token punctuation">,</span>
      folder <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../static/uploads'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'/'</span><span class="token punctuation">;</span>
    
    <span class="token keyword">var</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> cindex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//合并文件</span>
    <span class="token keyword">function</span> <span class="token function">fnMergeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> fname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cindex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
      readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">,</span> <span class="token punctuation">{</span> end<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cindex<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;</span> chunkCount<span class="token punctuation">)</span><span class="token punctuation">{</span>
          cindex <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token function">fnMergeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fnMergeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'merge ok 200'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>CODE</code></p> <p>https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo12</p> <h2 id="大文件上传-断点续传"><a href="#大文件上传-断点续传" aria-hidden="true" class="header-anchor">#</a> 大文件上传-断点续传</h2> <p>在上面我们实现了大文件的分片上传，解决了大文件上传超时和服务器的限制。</p> <p>但是仍然不够完美，大文件上传并不是短时间内就上传完成，如果期间断网，页面刷新了仍然需要重头上传。</p> <h2 id="方法1"><a href="#方法1" aria-hidden="true" class="header-anchor">#</a> 方法1</h2> <p>基于上面一个栗子进行改进，服务端已保存了部分片段，重新上传的时候，服务端对当前的分段进行对比，只接收本地没有的分段，前提是分段大小一致。</p> <p>在上面为了方便，使用了时间戳作为这个文件的标志，其实可以使用<code>spark-md5</code>来生成文件的 hash 值，这样服务器就可以进行文件的对比了。</p> <p>但是不好的地方是每个分段都要重新发送请求。</p> <h2 id="方法2-断点续传"><a href="#方法2-断点续传" aria-hidden="true" class="header-anchor">#</a> 方法2 - 断点续传</h2> <p>方法1中，重新上传时请求和数据还会发到服务器，其实已上传的分段就不应该再发送到服务器了，所以我们可以使用断点续传来进行改进。</p> <ul><li>为每个分段生成 hash 值，使用 <code>spark-md5</code> 库</li> <li>将上传成功的分段信息保存到本地</li> <li>重新上传时，进行和本地分段 hash 值的对比，如果相同的话则跳过，继续下一个分段的上传</li></ul> <p><strong>PS</strong></p> <p>生成 hash 过程肯定也会耗费资源，但是和重新上传相比可以忽略不计了。</p> <p><code>DEMO</code></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3c6f659bcdb1?imageslim" alt=""></p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/16/16dd3c6f65c598bd?imageslim" alt=""></p> <p><code>HTML</code></p> <div class="language-html extra-class"><pre class="language-html"><code>代码略 
复制代码
</code></pre></div><p><code>JS</code></p> <p>模拟分段保存，本地保存到<code>localStorage</code></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">//获得本地缓存的数据</span>
<span class="token keyword">function</span> <span class="token function">getUploadedFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>saveChunkKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;{}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//写入缓存</span>
<span class="token keyword">function</span> <span class="token function">setUploadedToStorage</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> obj <span class="token operator">=</span>  <span class="token function">getUploadedFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>      
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>saveChunkKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//分段对比</span>

<span class="token keyword">var</span> uploadedInfo <span class="token operator">=</span> <span class="token function">getUploadedFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得已上传的分段信息</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> chunkCount<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> uploadedInfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">?</span><span class="token string">'已上传过'</span><span class="token punctuation">:</span><span class="token string">'未上传'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span>uploadedInfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//对比分段</span>
    sendChunkCount<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//记录已上传的索引</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果已上传则跳过</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">xhrSend</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sendChunkCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">//将成功信息保存到本地</span>
      <span class="token function">setUploadedToStorage</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sendChunkCount <span class="token operator">===</span> chunkCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上传完成，发送合并请求'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> formD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'chunkCount'</span><span class="token punctuation">,</span> chunkCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">xhrSend</span><span class="token punctuation">(</span>formD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="node-端上传图片"><a href="#node-端上传图片" aria-hidden="true" class="header-anchor">#</a> node 端上传图片</h2> <p>不只会从客户端上传文件到服务器，服务器也会上传文件到其他服务器。</p> <ul><li>读取文件buffer <code>fs</code></li> <li>构建 form-data <code>form-data</code></li> <li>上传文件 <code>node-fetch</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
  * filepath = 相对根目录的路径即可
  */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getFileBufer</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> bufer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          err<span class="token punctuation">,</span>
          data
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * 上传文件
  */</span>
<span class="token keyword">let</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'form-data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>
    imgPath
  <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFileBufer</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">,</span> xxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'pic'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://xx.com/upload'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    body<span class="token punctuation">:</span> form<span class="token punctuation">,</span>
    method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span> form<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//要活的 form-data的头，否则无法上传</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="其他"><a href="#其他" aria-hidden="true" class="header-anchor">#</a> 其他</h2> <blockquote><p>在浏览器端对文件的类型、大小、尺寸进行判断</p></blockquote> <ul><li><code>file.type</code>判断类型</li> <li><code>file.size</code>判断大小</li> <li>通过动态创建 img 标签，图片加载后获得尺寸,<code>naturalWidth naturalHeight</code>or <code>width height</code></li></ul> <div class="language-JS extra-class"><pre class="language-js"><code>
<span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//判断类型</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>type<span class="token operator">!==</span><span class="token string">'image/jpeg'</span> <span class="token operator">&amp;&amp;</span>  f<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'image/jpg'</span>  <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'只能上传 jpg 图片'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  flag<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//判断大小</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token operator">&gt;</span><span class="token number">100</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'不能大于100kb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//判断图片尺寸</span>
<span class="token keyword">var</span> img <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
img<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'图片原始大小 width*height'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>naturalWidth<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'图片原始大小 naturalWidth*naturalHeight'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>naturalWidth<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>naturalHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'oImg.width*height'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>input file 外观更改</p></blockquote> <p>由于input file 的外观比较传统，很多地方都需要进行美化。</p> <ol><li>定义好一个外观，然后将 file input 定位到该元素上，让他的透明度为0。</li> <li>使用 label 标签</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Choose file to upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="3"><li>隐藏 input file 标签，然后调用 input 元素的 click 方法</li></ol> <p><strong>PS</strong></p> <p>file 标签隐藏后在 ie 下无法获得文件内容，建议还是<code>方法1</code> 兼容性强。</p> <h2 id="最后有两件小事"><a href="#最后有两件小事" aria-hidden="true" class="header-anchor">#</a> 最后有两件小事</h2> <ol><li>有想入群的学习前端进阶的加我微信 luoxue2479 回复加群即可</li> <li>我的 github 地址，所有我的文章及源码都在这里，欢迎来star</li></ol> <blockquote><p>https://github.com/luoxue-victor/source-code</p></blockquote> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <p>https://developer.mozilla.org/zh-CN/docs/Web/API/Blob</p> <p>https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest</p> <p>https://cloud.tencent.com/developer/news/323657</p> <p>https://github.com/Bigerfe/fe-learn-code/</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/xuege-learning/dist/assets/js/app.2fd7c63d.js" defer></script><script src="/xuege-learning/dist/assets/js/2.304eb466.js" defer></script><script src="/xuege-learning/dist/assets/js/30.0458713b.js" defer></script>
  </body>
</html>
